<!DOCTYPE html>
<html>
<head>
	<title>Node-Compose Monitor</title>
	<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
	<script src="https://code.jquery.com/jquery-3.0.0.min.js" integrity="sha256-JmvOoLtYsmqlsWxa7mDSLMwa6dZ9rrIdtrrVYRnDRH0=" crossorigin="anonymous"></script>

</head>
<body>

	<h1>Monitor</h1>

	<button id="fitness_app">Restart fitness_app</button>
	<button id="ps">PS</button>
	<button id="images">Images</button>
	<button id="reload">Reload</button>
	<button id="start_all">Start all</button>
	<button id="stop_all">Stop all</button>

	<pre id="logs" style="background: #222; color: #eee; padding: 20px; -webkit-font-smoothing: antialiased; overflow: auto; max-height: 400px;"><code></code></pre>


	<script type="text/javascript">

		var socket = io();

		socket.on('log', function(msg) {
			$('#logs code').append($('<div>').html(ansi2html(trimWhitespace(msg.data))));

			updateScroll('logs');
		});


		$('#fitness_app').click(function() {
			socket.emit('cmd', {
				cmd: 'restart',
				args: {
					image: 'fitness_app'
				}
			})
		});

		$('#ps').click(function() {
			socket.emit('cmd', {
				cmd: 'ps'
			})
		});

		$('#images').click(function() {
			socket.emit('cmd', {
				cmd: 'images'
			})
		});

		$('#reload').click(function() {
			socket.emit('cmd', {
				cmd: 'reload'
			})
		});

		$('#start_all').click(function() {
			socket.emit('cmd', {
				cmd: 'start',
				args: {
					image: 'all'
				}
			})
		});

		$('#stop_all').click(function() {
			socket.emit('cmd', {
				cmd: 'stop',
				args: {
					image: 'all'
				}
			})
		});


		function updateScroll(id){
		    var element = document.getElementById(id);
		    element.scrollTop = element.scrollHeight;
		}

		function trimWhitespace(str) {
			return (str || '').toString().replace(/^\s+|\s+$/g, '');
		}


		function ansi2html(str) {
		    var props = {}
		      , open = false

		    var stylemap =
		      { bold: "font-weight"
		      , underline: "text-decoration"
		      , color: "color"
		      , background: "background"
		      }

		    function style() {
		      var key, val, style = []
		      for (var key in props) {
		        val = props[key]
		        if (!val) continue
		        if (val == true) {
		          style.push(stylemap[key] + ':' + key)
		        } else {
		          style.push(stylemap[key] + ':' + val)
		        }
		      }
		      return style.join(';')
		    }


		    function tag(code) {
		      var i
		        , tag = ''
		        , n = ansi2html.table[code]

		      if (open) tag += '</span>'
		      open = false

		      if (n) {
		        for (i in n) props[i] = n[i]
		        tag += '<span style="' + style() + '">'
		        open = true
		      } else {
		        props = {}
		      }

		      return tag
		    }

		    return str.replace(/\[(\d+;)?(\d+)*m/g, function(match, b1, b2) {
		      var i, code, res = ''
		      if (b2 == '' || b2 == null) b2 = '0'
		      for (i = 1; i < arguments.length - 2; i++) {
		        if (!arguments[i]) continue
		        code = parseInt(arguments[i])
		        res += tag(code)
		      }
		      return res
		    }) + tag()
		  }

		  /* not implemented:
		   *   italic
		   *   blink
		   *   invert
		   *   strikethrough
		   */
		  ansi2html.table =
		  { 0: null
		  , 1: { bold: true }
		  , 3: { italic: true }
		  , 4: { underline: true }
		  , 5: { blink: true }
		  , 6: { blink: true }
		  , 7: { invert: true }
		  , 9: { strikethrough: true }
		  , 23: { italic: false }
		  , 24: { underline: false }
		  , 25: { blink: false }
		  , 27: { invert: false }
		  , 29: { strikethrough: false }
		  , 30: { color: 'black' }
		  , 31: { color: 'red' }
		  , 32: { color: 'green' }
		  , 33: { color: 'yellow' }
		  , 34: { color: 'blue' }
		  , 35: { color: 'magenta' }
		  , 36: { color: 'cyan' }
		  , 37: { color: 'white' }
		  , 39: { color: null }
		  , 40: { background: 'black' }
		  , 41: { background: 'red' }
		  , 42: { background: 'green' }
		  , 43: { background: 'yellow' }
		  , 44: { background: 'blue' }
		  , 45: { background: 'magenta' }
		  , 46: { background: 'cyan' }
		  , 47: { background: 'white' }
		  , 49: { background: null }
		  }



	</script>

</body>
</html>
